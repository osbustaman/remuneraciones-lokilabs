{% extends 'client/base.html' %}

{% load static_tags %}
{% load static %}

{% block title %} {{ action }} Colaborador {% endblock %}

{% block static_up %}

{% endblock %}

{% block title_page %} NOMBRE COLABORADOR {% endblock %}
{% block buttons %}
s
{% endblock %}

{% block content_page %}

<style>

</style>

    <div class="row row-sm mg-t-15 mg-sm-t-20">


        <div class="col-lg-3 mg-t-15 mg-sm-t-20 mg-lg-t-0">
            <div class="card pd-20">
                <h6 class="tx-12 tx-uppercase tx-inverse tx-bold mg-b-15">Sales Report</h6>
                <div class="d-flex mg-b-10">
                    <div class="bd-r pd-r-10">
                        <label class="tx-12">Today</label>
                        <p class="tx-lato tx-inverse tx-bold">1,898</p>
                    </div>
                    <div class="bd-r pd-x-10">
                        <label class="tx-12">This Week</label>
                        <p class="tx-lato tx-inverse tx-bold">32,112</p>
                    </div>
                    <div class="pd-l-10">
                        <label class="tx-12">This Month</label>
                        <p class="tx-lato tx-inverse tx-bold">72,067</p>
                    </div>
                </div><!-- d-flex -->
                <div class="progress mg-b-10">
                    <div class="progress-bar wd-50p" role="progressbar" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100">50%</div>
                </div>
                <p class="tx-12 mg-b-0">Maecenas tempus, tellus eget condimentum rhoncus</p>
            </div><!-- card -->

            <ul class="list-group widget-list-group bg-info mg-t-20">
                <div class="card pd-20">
                    <div class="pd-10 bd">
                        <ul class="nav nav-pills flex-column" role="tablist">
                            <li id="datos_personales" class="nav-item"><a class="nav-link active" data-toggle="tab" href="#" role="tab" aria-expanded="true">Datos Personales</a></li>
                            <li id="datos_laborales" class="nav-item"><a class="nav-link" data-toggle="tab" href="#" role="tab">Datos Laborales</a></li>
                            <li id="datos_previsionales" class="nav-item"><a class="nav-link" data-toggle="tab" href="#" role="tab">Datos Previsionales</a></li>
                            <li id="cargas_familiares" class="nav-item"><a class="nav-link" data-toggle="tab" href="#" role="tab">Cargas Familiares</a></li>
                            <li id="horario" class="nav-item"><a class="nav-link" data-toggle="tab" href="#" role="tab">Horario</a></li>
                            <li id="datos_pago" class="nav-item"><a class="nav-link" data-toggle="tab" href="#" role="tab">Datos de Pago</a></li>
                            <li id="vacaciones_ausencia" class="nav-item"><a class="nav-link" data-toggle="tab" href="#" role="tab">Vacaciones y Ausencias</a></li>
                            <li id="finiquito" class="nav-item"><a class="nav-link" data-toggle="tab" href="#" role="tab">Finiquito</a></li>
                            <li id="documentos" class="nav-item"><a class="nav-link" data-toggle="tab" href="#" role="tab">Documentos</a></li>
                            <li id="conceptos_remuneraciones" class="nav-item"><a class="nav-link" data-toggle="tab" href="#" role="tab">Concepto Remuneraciones</a></li>
                        </ul>
                    </div>
                </div>
            </ul>
        </div><!-- col-4 -->

        <div class="col-lg-9">
            <div class="card">
                <div class="card pd-10 pd-sm-20 form-layout form-layout-5">
                    <form method="post" id="form-datos-personales">
                        <div id="div_datos_personales">
                            <div class="row row-xs">
                                <label class="col-sm-3 form-control-label"><span class="tx-danger">*</span> Rut:</label>
                                <div class="col-sm-4 mg-t-10 mg-sm-t-0">
                                    <input type="text" class="form-control form-control-sm" id="col_rut">
                                </div>
                            </div><!-- row -->
                            <div class="row row-xs mg-t-20">
                                <label class="col-sm-3 form-control-label"><span class="tx-danger">*</span> Apellidos:</label>
                                <div class="col-sm-4 mg-t-10 mg-sm-t-0">
                                    <input type="text" class="form-control form-control-sm" id="apellidos">
                                </div>
                            </div>
                            <div class="row row-xs mg-t-20">
                                <label class="col-sm-3 form-control-label"><span class="tx-danger">*</span> Nombres:</label>
                                <div class="col-sm-4 mg-t-10 mg-sm-t-0">
                                    <input type="text" class="form-control form-control-sm" id="nombres">
                                </div>
                            </div>
                            <div class="row row-xs mg-t-20">
                                <label class="col-sm-3 form-control-label"><span class="tx-danger">*</span> Email:</label>
                                <div class="col-sm-4 mg-t-10 mg-sm-t-0">
                                    <input type="text" class="form-control form-control-sm" id="email">
                                </div>
                            </div><!-- row -->
                            <div class="row row-xs mg-t-20">
                                <label class="col-sm-3 form-control-label"><span class="tx-danger">*</span> Dirección:</label>
                                <div class="col-sm-4 mg-t-10 mg-sm-t-0">
                                    <input type="text" class="form-control form-control-sm" id="col_direccion">
                                </div>
                            </div><!-- row -->
                            <div class="row row-xs mg-t-20">
                                <label class="col-sm-3 form-control-label"><span class="tx-danger">*</span> País:</label>
                                <div class="col-sm-4 mg-t-10 mg-sm-t-0">
                                    <select id="pais" class="form-control form-control-sm">
                                        <option value="">[Seleccione]</option>
                                    </select>
                                </div>
                            </div><!-- row -->
                            <div class="row row-xs mg-t-20">
                                <label class="col-sm-3 form-control-label"><span class="tx-danger">*</span> Región:</label>
                                <div class="col-sm-4 mg-t-10 mg-sm-t-0">
                                    <select id="region" class="form-control form-control-sm">
                                        <option value="">[Seleccione]</option>
                                    </select>
                                </div>
                            </div><!-- row -->
                            <div class="row row-xs mg-t-20">
                                <label class="col-sm-3 form-control-label"><span class="tx-danger">*</span> Comuna:</label>
                                <div class="col-sm-4 mg-t-10 mg-sm-t-0">
                                    <select id="comuna" class="form-control form-control-sm">
                                        <option value="">[Seleccione]</option>
                                    </select>
                                </div>
                            </div><!-- row -->
                            <div class="row row-xs mg-t-20">
                                <label class="col-sm-3 form-control-label"><span class="tx-danger">*</span> Sexo:</label>
                                <div class="col-sm-4 mg-t-10 mg-sm-t-0">
                                    <select id="col_sexo" class="form-control form-control-sm">
                                        <option value="">[Seleccione]</option>
                                    </select>
                                </div>
                            </div><!-- row -->
                            <div class="row row-xs mg-t-20">
                                <label class="col-sm-3 form-control-label"><span class="tx-danger">*</span> Estado Civil:</label>
                                <div class="col-sm-4 mg-t-10 mg-sm-t-0">
                                    <select id="col_estadocivil" class="form-control form-control-sm">
                                        <option value="">[Seleccione]</option>
                                    </select>
                                </div>
                            </div><!-- row -->
                            <div class="row row-xs mg-t-20">
                                <label class="col-sm-3 form-control-label"><span class="tx-danger">*</span> Es Extranjero?:</label>
                                <div class="col-sm-4 mg-t-10 mg-sm-t-0">
                                    <select id="col_extranjero" class="form-control form-control-sm">
                                        <option value="">[Seleccione]</option>
                                    </select>
                                </div>
                            </div><!-- row -->
                            <div class="row row-xs mg-t-20">
                                <label class="col-sm-3 form-control-label"><span class="tx-danger">*</span> Nacionalidad:</label>
                                <div class="col-sm-4 mg-t-10 mg-sm-t-0">
                                    <input type="text" class="form-control form-control-sm" id="col_nacionalidad" value="Chileno">
                                </div>
                            </div><!-- row -->
                            <div class="row row-xs mg-t-20">
                                <label class="col-sm-3 form-control-label"><span class="tx-danger">*</span> Fecha Nacimiento:</label>
                                <div class="col-sm-4 mg-t-10 mg-sm-t-0">
                                    <input type="text" class="form-control fc-datepicker form-control-sm" placeholder="YYYY-MM-DD" required id="col_fechanacimiento">
                                </div>
                            </div><!-- row -->
                            <div class="row row-xs mg-t-20">
                                <label class="col-sm-3 form-control-label"><span class="tx-danger">*</span> Tipo Estudios:</label>
                                <div class="col-sm-4 mg-t-10 mg-sm-t-0">
                                    <select id="col_estudios" class="form-control form-control-sm">
                                        <option value="">[Seleccione]</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row row-xs mg-t-20">
                                <label class="col-sm-3 form-control-label"><span class="tx-danger">*</span> Estado Estudios:</label>
                                <div class="col-sm-4 mg-t-10 mg-sm-t-0">
                                    <select id="col_estadoestudios" class="form-control form-control-sm">
                                        <option value="">[Seleccione]</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row row-xs mg-t-20">
                                <label class="col-sm-3 form-control-label"><span class="tx-danger">*</span> Título:</label>
                                <div class="col-sm-4 mg-t-10 mg-sm-t-0">
                                    <input type="text" class="form-control form-control-sm" id="col_titulo">
                                </div>
                            </div><!-- row -->

                            <div class="row row-xs mg-t-20">
                                <label class="col-sm-3 form-control-label"><span class="tx-danger">*</span> Licencia Conducir:</label>
                                <div class="col-sm-4 mg-t-10 mg-sm-t-0">
                                    <select id="col_licenciaconducir" class="form-control form-control-sm" onchange="change_validation()">
                                        <option value="">[Seleccione]</option>
                                    </select>
                                </div>
                            </div><!-- row -->

                            <div class="row row-xs mg-t-20">
                                <label class="col-sm-3 form-control-label"><span class="tx-danger"></span> Clase Licencia:</label>
                                <div class="col-sm-4 mg-t-10 mg-sm-t-0">
                                    <input type="text" class="form-control form-control-sm not-required" id="col_tipolicencia">
                                </div>
                            </div><!-- row -->

                            <div class="row row-xs mg-t-20">
                                <label class="col-sm-3 form-control-label"><span class="tx-danger">*</span> Rol:</label>
                                <div class="col-sm-4 mg-t-10 mg-sm-t-0">
                                    <select id="col_tipousuario" class="form-control form-control-sm">
                                        <option value="">[Seleccione]</option>
                                    </select>
                                </div>
                            </div><!-- row -->
                            
                            <div class="row row-xs mg-t-30">
                                <div class="col-sm-10 mg-l-auto">
                                    <div class="form-layout-footer">
                                        <button type="button" class="btn btn-info mg-r-5" onclick="save_data('form-datos-personales')">Guardar</button>
                                    </div><!-- form-layout-footer -->
                                </div><!-- col-8 -->
                            </div>
                        </div>
                    </form>
                    <div id="div_datos_laborales">adadasd</div>
                </div>
            </div><!-- card -->
        </div><!-- col-8 -->

        
    </div>


    <div id="modaldemo1" class="modal fade">
        <div class="modal-dialog modal-dialog-vertical-center" role="document">
            <div class="modal-content bd-0 tx-14">
                <div class="modal-header pd-y-20 pd-x-25">
                    <h6 class="tx-14 mg-b-0 tx-uppercase tx-inverse tx-bold">Message Preview</h6>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body pd-25">
                    <h4 class="lh-3 mg-b-20"><a href="" class="tx-inverse hover-primary">Why We Use Electoral College, Not Popular Vote</a></h4>
                    <p class="mg-b-5">It is a long established fact that a reader will be distracted by the readable content of a page when looking at its layout. The point of using Lorem Ipsum is that it has a more-or-less normal distribution of letters, as opposed to using 'Content here, content here', making it look like readable English. </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info pd-x-20">Save changes</button>
                    <button type="button" class="btn btn-secondary pd-x-20" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div><!-- modal-dialog -->
    </div><!-- modal -->


{% endblock %}

{% block static_down %}


{% endblock %}

{% block script_tag %}
<script>

$('.fc-datepicker').datepicker({
    showOtherMonths: true,
    selectOtherMonths: true,
    dateFormat: 'yy-mm-dd',
});

const datos_personales = document.getElementById('datos_personales');
const datos_laborales = document.getElementById('datos_laborales');

const div_datos_personales = document.getElementById('div_datos_personales');
const div_datos_laborales = document.getElementById('div_datos_laborales');

const formulario = document.getElementById('form');

div_datos_personales.style.display = 'none';
div_datos_laborales.style.display = 'none';

const load_page = "{% url 'usuario_app:ApiLoadPageColaborator' %}";

const handleResponse = async (response) => {
    try {
        let {
            data: { sexo_dict, estado_civil_dict, opciones_dict, tipo_estudios_dict, estados_estudios_dict, object_rol_dict, paises, regiones }
        } = response;

        const selectSexo = document.getElementById('col_sexo');
        const selectEstadoCivil = document.getElementById('col_estadocivil');
        const selectExtranjero = document.getElementById('col_extranjero');
        const selectLicenciaConducir = document.getElementById('col_licenciaconducir');
        const selectTipoEstudiosDict = document.getElementById('col_estudios');
        const selectEstadosEstudiosDict = document.getElementById('col_estadoestudios');
        const selectObjectRolDict = document.getElementById('col_tipousuario');

        const createOptions = (obj, selectElement) => {
            const options = Object.entries(obj).map(([value, label]) => {
                const option = document.createElement('option');
                option.value = value;
                option.text = label;
                return option;
            });

            options.forEach(option => {
                selectElement.appendChild(option);
            });
        };

        const createOptionsRol = (obj, selectRol) => {
            const options_rol_select = obj.map(result => {
                return `
                <option value="${result.rol_id}">${result.rol_name}</option>
                `; 
            }).join('');
            selectRol.innerHTML = options_rol_select;
        };

        createOptionsRol(object_rol_dict, selectObjectRolDict);
        createOptions(sexo_dict, selectSexo);
        createOptions(estado_civil_dict, selectEstadoCivil);
        createOptions(opciones_dict, selectExtranjero);
        createOptions(opciones_dict, selectLicenciaConducir);
        createOptions(tipo_estudios_dict, selectTipoEstudiosDict);
        createOptions(estados_estudios_dict, selectEstadosEstudiosDict);

    } catch (error) {
        console.error('Error en la solicitud:', error.message);
    }
};


axios.get(load_page)
    .then(response => handleResponse(response))
    .catch(error => {
        console.error('Error en la solicitud:', error.message);
    });


datos_personales.addEventListener('click', async () => {
    try {
        const endpoint = "{% url 'usuario_app:ApiGetPersonalData' user_id %}";
        const response = await axios.get(endpoint);

        const { data: { data } } = response;
        const { data: { regions, comuns, countries } } = response;
        const { col_rut, col_extranjero, col_nacionalidad, col_sexo, col_fechanacimiento, email } = data[0]
        const { col_estadocivil, col_direccion, pais, region, comuna, first_name, last_name } = data[0]
        const { col_estudios, col_estadoestudios, col_titulo, col_licenciaconducir, col_tipolicencia, col_tipousuario } = data[0]
        
        const select_pais = document.getElementById('pais');
        const select_regiones = document.getElementById('region');
        const select_comuns = document.getElementById('comuna');

        document.getElementById('col_rut').value = col_rut;
        document.getElementById('apellidos').value = first_name;
        document.getElementById('nombres').value = last_name;
        document.getElementById('email').value = email;
        document.getElementById('col_direccion').value = col_direccion;

        const options_pais = countries.map(result => {
            return `
            <option value="${result.pa_id}">${result.pa_nombre}</option>
            `; 
        }).join('');
        select_pais.innerHTML = options_pais;
        select_pais.value = pais;

        const options_select = regions.map(result => {
            return `
            <option value="${result.re_id}">${result.re_nombre}</option>
            `; 
        }).join('');
        select_regiones.innerHTML = options_select;
        select_regiones.value = region;

        const options_comuns = comuns.map(result => {
            return `
            <option value="${result.com_id}">${result.com_nombre}</option>
            `; 
        }).join('');
        select_comuns.innerHTML = options_comuns;
        select_comuns.value = comuna;

        document.getElementById('col_sexo').value = col_sexo;
        document.getElementById('col_estadocivil').value = col_estadocivil;
        document.getElementById('col_extranjero').value = col_extranjero;
        document.getElementById('col_nacionalidad').value = col_nacionalidad;
        document.getElementById('col_fechanacimiento').value = col_fechanacimiento;
        document.getElementById('col_estudios').value = col_estudios;
        document.getElementById('col_estadoestudios').value = col_estadoestudios;
        document.getElementById('col_titulo').value = col_titulo;
        document.getElementById('col_licenciaconducir').value = col_licenciaconducir;
        document.getElementById('col_tipolicencia').value = col_tipolicencia;
        document.getElementById('col_tipousuario').value = col_tipousuario;

        div_datos_personales.style.display = 'block';
        div_datos_laborales.style.display = 'none';

    } catch (error) {
        console.error('Error en la solicitud:', error.message);
    }
});

const validate_inputs = (form_name) => {
    const formulario = document.getElementById(form_name);
    const elementos = formulario.elements;
    let is_vacio = true;

    for (let i = 0; i < elementos.length; i++) {
        const elemento = elementos[i];
        
        if(elemento.type === "button"){
        }else{
            const value = elemento.value.trim();
            const classes = elemento.className.split(' ');
            const hasRequiredClass = classes.includes('not-required');

            if (!hasRequiredClass && (elemento.value).length === 0) {
                is_vacio = false;
            }
        }
    }

    if(!is_vacio){
        return false;
    }
    return true;
}

const get_dict_form = (form_name) => {
    const formulario = document.getElementById(form_name);
    const elementos = formulario.elements;
    const diccionario = {};
    for (let i = 0; i < elementos.length; i++) {
        const elemento = elementos[i];

        if((elemento.value).length != 0){
            let key = elemento.id;

            console.log(elemento.type)

            const classes = elemento.className.split(' ');
            const hasRequiredClass = classes.includes('not-required');

            if (!hasRequiredClass) {
                diccionario[key] = elemento.value;
            }
        }
    }

    console.log(diccionario)

    return diccionario;
}

// 1-225757424028


const save_data = (form_name) => {
    const dict_form = get_dict_form(form_name);
    const _validate_inputs = validate_inputs(form_name);

    if(!_validate_inputs){
        $.alert({
            title: 'Mensaje!',
            content: 'El formulario no esta completo, favor de revisar y volver a intentar',
        });
    }else{

        let apellidos = document.getElementById('apellidos').value;
        let nombres = document.getElementById('nombres').value;
        let email = document.getElementById('email').value;

        let col_rut = document.getElementById('col_rut').value;
        let col_sexo = document.getElementById('col_sexo').value;
        let col_estadocivil = document.getElementById('col_estadocivil').value;
        let col_extranjero = document.getElementById('col_extranjero').value;
        let col_nacionalidad = document.getElementById('col_nacionalidad').value;
        let col_fechanacimiento = document.getElementById('col_fechanacimiento').value;
        let col_estudios = document.getElementById('col_estudios').value;
        let col_estadoestudios = document.getElementById('col_estadoestudios').value;
        let col_titulo = document.getElementById('col_titulo').value;
        let col_licenciaconducir = document.getElementById('col_licenciaconducir').value;
        let col_tipolicencia = document.getElementById('col_tipolicencia').value;
        let col_tipousuario = document.getElementById('col_tipousuario').value;
        let col_direccion = document.getElementById('col_direccion').value;

        let pais = document.getElementById('pais').value;
        let region = document.getElementById('region').value;
        let comuna = document.getElementById('comuna').value;

        const link_to = `{% url 'usuario_app:PersonalDataEditView' user_id %}`


        let dict_form = {
            "col_rut": col_rut,
            "apellidos": apellidos,
            "nombres": nombres,
            "email": email,
            "col_direccion": col_direccion,
            "pais": Number(pais),
            "region": Number(region),
            "comuna": Number(comuna),
            "col_sexo": col_sexo,
            "col_estadocivil": Number(col_estadocivil),
            "col_extranjero": Number(col_extranjero),
            "col_nacionalidad": col_nacionalidad,
            "col_fechanacimiento": col_fechanacimiento,
            "col_estudios": Number(col_estudios),
            "col_estadoestudios": Number(col_estadoestudios),
            "col_titulo": col_titulo,
            "col_licenciaconducir": Number(col_licenciaconducir),
            "col_tipousuario": Number(col_tipousuario)
        }

        axios.put(link_to, dict_form)
            .then(response => {
                $.alert({
                    title: 'Mensaje!',
                    content: 'Los datos del colaborador fueron actualizados con éxito!',
                });
            })
            .catch(error => {
                $.alert({
                    title: 'Mensaje!',
                    content: `Error en la solicitud: ${error.message}`,
                });
            });
    }
}

const change_validation = () => {
    const input = document.getElementById('col_licenciaconducir');
    const input_txt = document.getElementById('col_tipolicencia');

    if(input.value === '1'){
        input_txt.classList.remove('not-required');
    }else{
        input_txt.classList.add('not-required');
    }
};


</script>
{% endblock %}